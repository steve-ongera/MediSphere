{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ patient.full_name }} - Patient Profile{% endblock %}

{% block content %}
<!-- Page Title -->
<div class="pagetitle">
    <h1><i class="bi bi-person-vcard me-2"></i>{{ patient.full_name }}</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'receptionist_dashboard' %}"><i class="bi bi-house-door"></i> Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'receptionist_patient_records' %}">Patients</a></li>
            <li class="breadcrumb-item active">{{ patient.patient_number }}</li>
        </ol>
    </nav>
</div>

<section class="section profile">
    <div class="row">
        <!-- Left Sidebar - Patient Info Card -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                    <div class="avatar-container mb-3">
                        <div class="avatar avatar-xxl bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-person text-white" style="font-size: 4rem;"></i>
                        </div>
                    </div>
                    <h2>{{ patient.full_name }}</h2>
                    <h3 class="text-muted">{{ patient.patient_number }}</h3>
                    <div class="mt-2">
                        {% if patient.gender == 'MALE' %}
                        <span class="badge bg-info me-2"><i class="bi bi-gender-male me-1"></i>Male</span>
                        {% elif patient.gender == 'FEMALE' %}
                        <span class="badge bg-pink me-2"><i class="bi bi-gender-female me-1"></i>Female</span>
                        {% endif %}
                        <span class="badge bg-secondary">{{ patient.age }} years</span>
                    </div>
                </div>
                
                <div class="card-body pt-0">
                    <h5 class="card-title border-bottom pb-2">Contact Information</h5>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label"><i class="bi bi-phone me-2"></i>Phone</div>
                        <div class="col-lg-8 col-md-8">{{ patient.phone_number }}</div>
                    </div>
                    {% if patient.alternate_phone %}
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label"><i class="bi bi-phone me-2"></i>Alt Phone</div>
                        <div class="col-lg-8 col-md-8">{{ patient.alternate_phone }}</div>
                    </div>
                    {% endif %}
                    {% if patient.email %}
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label"><i class="bi bi-envelope me-2"></i>Email</div>
                        <div class="col-lg-8 col-md-8">{{ patient.email }}</div>
                    </div>
                    {% endif %}
                    
                    <h5 class="card-title border-bottom pb-2 mt-4">Personal Details</h5>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label"><i class="bi bi-card-text me-2"></i>ID Number</div>
                        <div class="col-lg-8 col-md-8">{{ patient.id_number|default:"N/A" }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label"><i class="bi bi-calendar me-2"></i>Date of Birth</div>
                        <div class="col-lg-8 col-md-8">{{ patient.date_of_birth|date:"F d, Y" }}</div>
                    </div>
                    {% if patient.blood_group %}
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label"><i class="bi bi-droplet me-2"></i>Blood Group</div>
                        <div class="col-lg-8 col-md-8"><span class="badge bg-danger">{{ patient.blood_group }}</span></div>
                    </div>
                    {% endif %}
                    
                    <h5 class="card-title border-bottom pb-2 mt-4">Location</h5>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label"><i class="bi bi-geo-alt me-2"></i>County</div>
                        <div class="col-lg-8 col-md-8">{{ patient.county }}</div>
                    </div>
                    {% if patient.sub_county %}
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label">Sub-County</div>
                        <div class="col-lg-8 col-md-8">{{ patient.sub_county }}</div>
                    </div>
                    {% endif %}
                    {% if patient.ward %}
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label">Ward</div>
                        <div class="col-lg-8 col-md-8">{{ patient.ward }}</div>
                    </div>
                    {% endif %}
                    
                    <h5 class="card-title border-bottom pb-2 mt-4">NHIF Status</h5>
                    <div class="row mb-2">
                        <div class="col-12">
                            {% if patient.nhif_status == 'ACTIVE' %}
                            <span class="badge bg-success w-100"><i class="bi bi-check-circle me-1"></i>Active</span>
                            {% elif patient.nhif_status == 'CIVIL_SERVANT' %}
                            <span class="badge bg-info w-100"><i class="bi bi-briefcase me-1"></i>Civil Servant</span>
                            {% elif patient.nhif_status == 'INACTIVE' %}
                            <span class="badge bg-warning w-100"><i class="bi bi-exclamation-triangle me-1"></i>Inactive</span>
                            {% else %}
                            <span class="badge bg-secondary w-100"><i class="bi bi-x-circle me-1"></i>Not Registered</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if patient.nhif_number %}
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label">NHIF No.</div>
                        <div class="col-lg-8 col-md-8">{{ patient.nhif_number }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-4 d-grid gap-2">
                        <a href="{% url 'receptionist_edit_patient' patient.patient_number %}" class="btn btn-primary">
                            <i class="bi bi-pencil me-2"></i>Edit Patient Info
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Content Area -->
        <div class="col-xl-8">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card info-card">
                        <div class="card-body">
                            <h5 class="card-title">Total Visits</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" 
                                     style="background: #e3f2fd; color: #2196f3;">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ total_visits }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card info-card">
                        <div class="card-body">
                            <h5 class="card-title">Total Billed</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" 
                                     style="background: #fff3e0; color: #ff9800;">
                                    <i class="bi bi-receipt"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>KES {{ total_amount_billed|floatformat:2 }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card info-card">
                        <div class="card-body">
                            <h5 class="card-title">Amount Paid</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" 
                                     style="background: #e8f5e9; color: #4caf50;">
                                    <i class="bi bi-cash-coin"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>KES {{ total_amount_paid|floatformat:2 }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card info-card">
                        <div class="card-body">
                            <h5 class="card-title">Balance</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" 
                                     style="background: #ffebee; color: #f44336;">
                                    <i class="bi bi-exclamation-circle"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>KES {{ outstanding_balance|floatformat:2 }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <ul class="nav nav-tabs nav-tabs-bordered" id="patientTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                    data-bs-target="#overview" type="button" role="tab">
                                <i class="bi bi-house me-2"></i>Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="visits-tab" data-bs-toggle="tab" 
                                    data-bs-target="#visits" type="button" role="tab">
                                <i class="bi bi-calendar-check me-2"></i>Visits
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="billing-tab" data-bs-toggle="tab" 
                                    data-bs-target="#billing" type="button" role="tab">
                                <i class="bi bi-receipt me-2"></i>Billing
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="medical-tab" data-bs-toggle="tab" 
                                    data-bs-target="#medical" type="button" role="tab">
                                <i class="bi bi-heart-pulse me-2"></i>Medical Info
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content pt-3" id="patientTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>Patient Summary</h5>
                            
                            <!-- Next of Kin -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-person-badge me-2"></i>Next of Kin</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Name:</strong> {{ patient.next_of_kin_name }}</p>
                                            <p><strong>Relationship:</strong> {{ patient.next_of_kin_relationship }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Phone:</strong> {{ patient.next_of_kin_phone }}</p>
                                            {% if patient.next_of_kin_address %}
                                            <p><strong>Address:</strong> {{ patient.next_of_kin_address }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Admissions -->
                            {% if admissions %}
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-hospital me-2"></i>Recent Admissions</h6>
                                </div>
                                <div class="card-body">
                                    <div class="list-group list-group-flush">
                                        {% for admission in admissions %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ admission.admission_number }}</h6>
                                                <small>{{ admission.admission_datetime|date:"d M Y" }}</small>
                                            </div>
                                            <p class="mb-1">{{ admission.admission_diagnosis|truncatewords:15 }}</p>
                                            <small>Ward: {{ admission.bed.ward.name }}, Bed {{ admission.bed.bed_number }}</small>
                                            <span class="badge bg-{{ admission.status|lower }} ms-2">{{ admission.get_status_display }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Registration Info -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-info-square me-2"></i>Registration Information</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Registered On:</strong> {{ patient.registration_date|date:"F d, Y H:i" }}</p>
                                    <p><strong>Registered By:</strong> {{ patient.registered_by.get_full_name }}</p>
                                    {% if patient.notes %}
                                    <p><strong>Notes:</strong></p>
                                    <p class="text-muted">{{ patient.notes }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Visits Tab -->
                        <div class="tab-pane fade" id="visits" role="tabpanel">
                            <h5 class="mb-3"><i class="bi bi-calendar-check me-2"></i>Visit History</h5>
                            {% if recent_visits %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Visit #</th>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Chief Complaint</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for visit in recent_visits %}
                                        <tr>
                                            <td><span class="badge bg-primary">{{ visit.visit_number }}</span></td>
                                            <td>{{ visit.visit_date|date:"d M Y" }}</td>
                                            <td><span class="badge bg-info">{{ visit.get_visit_type_display }}</span></td>
                                            <td>{{ visit.chief_complaint|truncatewords:8 }}</td>
                                            <td><span class="badge bg-{{ visit.status|lower }}">{{ visit.get_status_display }}</span></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-calendar-x" style="font-size: 3rem; color: #ccc;"></i>
                                <p class="text-muted mt-3">No visits recorded yet</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Billing Tab -->
                        <div class="tab-pane fade" id="billing" role="tabpanel">
                            <h5 class="mb-3"><i class="bi bi-receipt me-2"></i>Billing History</h5>
                            {% if recent_invoices %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Date</th>
                                            <th>Total Amount</th>
                                            <th>Paid</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for invoice in recent_invoices %}
                                        <tr>
                                            <td><span class="badge bg-secondary">{{ invoice.invoice_number }}</span></td>
                                            <td>{{ invoice.invoice_date|date:"d M Y" }}</td>
                                            <td>KES {{ invoice.total_amount|floatformat:2 }}</td>
                                            <td>KES {{ invoice.amount_paid|floatformat:2 }}</td>
                                            <td>
                                                <strong {% if invoice.balance > 0 %}class="text-danger"{% endif %}>
                                                    KES {{ invoice.balance|floatformat:2 }}
                                                </strong>
                                            </td>
                                            <td><span class="badge bg-{{ invoice.status|lower }}">{{ invoice.get_status_display }}</span></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-receipt" style="font-size: 3rem; color: #ccc;"></i>
                                <p class="text-muted mt-3">No invoices generated yet</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Medical Info Tab -->
                        <div class="tab-pane fade" id="medical" role="tabpanel">
                            <h5 class="mb-3"><i class="bi bi-heart-pulse me-2"></i>Medical Information</h5>
                            
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>Allergies</h6>
                                </div>
                                <div class="card-body">
                                    {% if patient.allergies %}
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        {{ patient.allergies }}
                                    </div>
                                    {% else %}
                                    <p class="text-muted mb-0">No allergies recorded</p>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-clipboard2-pulse me-2"></i>Chronic Conditions</h6>
                                </div>
                                <div class="card-body">
                                    {% if patient.chronic_conditions %}
                                    <p>{{ patient.chronic_conditions }}</p>
                                    {% else %}
                                    <p class="text-muted mb-0">No chronic conditions recorded</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .bg-pink {
        background-color: #e91e63 !important;
    }
    .card-icon {
        width: 56px;
        height: 56px;
        font-size: 24px;
    }
    .avatar-xxl {
        width: 120px;
        height: 120px;
    }
</style>
{% endblock %}