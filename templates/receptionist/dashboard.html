{% extends "base/base.html" %}
{% load static %}

{% block title %}MediSphere - Reception Dashboard{% endblock %}

{% block content %}
<div class="message-container" id="system-messages">
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
</div>

<div class="pagetitle">
    <h1>Reception Dashboard</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'receptionist_dashboard' %}">Home</a></li>
        <li class="breadcrumb-item active">Dashboard</li>
        <li class="breadcrumb-item">{{ request.user.get_full_name }}</li>
      </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section dashboard">
    <div class="row">
      <!-- Left side columns -->
      <div class="col-lg-8">
        <div class="row">
          <!-- Receptionist Profile Card -->
          <div class="col-xxl-4 col-md-6">
            <div class="card info-card" style="border-left: 5px solid #1a76d1;">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #1a76d1;">
                    <i class="bi bi-person-badge text-white"></i>
                  </div>
                  <div class="ps-3">
                    <h5 class="card-title mb-0">{{ request.user.get_full_name }}</h5>
                    <span class="small text-muted">{{ request.user.role.name|default:"Receptionist" }}</span>
                    <div class="employee-status mt-1">
                      <span class="badge bg-success">
                        Active
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- End Profile Card -->

          <!-- Today's Appointments Card -->
          <div class="col-xxl-4 col-md-6">
            <div class="card info-card" style="border-left: 5px solid #4CAF50;">
              <div class="card-body">
                <h5 class="card-title">Today's Appointments</h5>
                <div class="d-flex align-items-center">
                  <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #4CAF50;">
                    <i class="bi bi-calendar-check text-white"></i>
                  </div>
                  <div class="ps-3">
                    <h6>{{ todays_appointments.count }}</h6>
                    <span class="text-muted small">Appointments</span>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- End Appointments Card -->

          <!-- New Patients Card -->
          <div class="col-xxl-4 col-md-6">
            <div class="card info-card" style="border-left: 5px solid #2196F3;">
              <div class="card-body">
                <h5 class="card-title">New Patients</h5>
                <div class="d-flex align-items-center">
                  <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #2196F3;">
                    <i class="bi bi-person-plus text-white"></i>
                  </div>
                  <div class="ps-3">
                    <h6>{{ new_patients_this_week }}</h6>
                    <span class="text-muted small">This week</span>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- End Patients Card -->

          <!-- Today's Visits Card -->
          <div class="col-xxl-4 col-md-6">
            <div class="card info-card" style="border-left: 5px solid #FF9800;">
              <div class="card-body">
                <h5 class="card-title">Today's Visits</h5>
                <div class="d-flex align-items-center">
                  <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #FF9800;">
                    <i class="bi bi-people text-white"></i>
                  </div>
                  <div class="ps-3">
                    <h6>{{ todays_visits.count }}</h6>
                    <span class="text-muted small">Patient Visits</span>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- End Visits Card -->

          <!-- Pending Prescriptions Card -->
          <div class="col-xxl-4 col-md-6">
            <div class="card info-card" style="border-left: 5px solid #9C27B0;">
              <div class="card-body">
                <h5 class="card-title">Pending Prescriptions</h5>
                <div class="d-flex align-items-center">
                  <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #9C27B0;">
                    <i class="bi bi-prescription text-white"></i>
                  </div>
                  <div class="ps-3">
                    <h6>{{ pending_prescriptions.count }}</h6>
                    <span class="text-muted small">To be dispensed</span>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- End Prescriptions Card -->

          <!-- Quick Actions -->
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Quick Actions</h5>
                <div class="row text-center">
                  <div class="col-md-3 col-6 mb-3">
                    <a href="{% url 'receptionist_register_patient' %}" class="btn btn-primary btn-sm w-100 py-2">
                      <i class="bi bi-person-plus"></i><br>
                      New Patient
                    </a>
                  </div>
                  <div class="col-md-3 col-6 mb-3">
                    <a href="{% url 'receptionist_schedule_appointment' %}" class="btn btn-outline-primary btn-sm w-100 py-2">
                      <i class="bi bi-calendar-plus"></i><br>
                      New Appointment
                    </a>
                  </div>
                  <div class="col-md-3 col-6 mb-3">
                    <a href="{% url 'receptionist_create_visit' %}" class="btn btn-outline-primary btn-sm w-100 py-2">
                      <i class="bi bi-clipboard-plus"></i><br>
                      New Visit
                    </a>
                  </div>
                  <div class="col-md-3 col-6 mb-3">
                    <a href="#" class="btn btn-outline-primary btn-sm w-100 py-2">
                      <i class="bi bi-cash-stack"></i><br>
                      Process Payment
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- End Quick Actions -->

          <!-- Today's Appointments -->
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title">Today's Appointments</h5>
                  <a href="{% url 'receptionist_view_appointments' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Time</th>
                        <th>Patient</th>
                        <th>Doctor</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for appointment in todays_appointments|slice:":5" %}
                      <tr>
                        <td>{{ appointment.appointment_datetime|time:"H:i" }}</td>
                        <td>{{ appointment.patient.full_name }}</td>
                        <td>Dr. {{ appointment.doctor.last_name }}</td>
                        <td>{{ appointment.appointment_type }}</td>
                        <td>
                          <span class="badge bg-{% if appointment.status == 'COMPLETED' %}success{% elif appointment.status == 'CANCELLED' %}danger{% elif appointment.status == 'IN_PROGRESS' %}info{% elif appointment.status == 'CONFIRMED' %}primary{% else %}warning{% endif %}">
                            {{ appointment.get_status_display }}
                          </span>
                        </td>
                        <td>
                          <a href="{% url 'appointment_detail' appointment.id %}" class="btn btn-sm btn-outline-primary">View</a>
                        </td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="6" class="text-center text-muted">No appointments scheduled for today</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div><!-- End Today's Appointments -->

          <!-- Today's Patient Visits -->
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title">Today's Patient Visits</h5>
                  <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Visit No.</th>
                        <th>Patient</th>
                        <th>Type</th>
                        <th>Queue</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for visit in todays_visits|slice:":5" %}
                      <tr>
                        <td>{{ visit.visit_number }}</td>
                        <td>{{ visit.patient.full_name }}</td>
                        <td>{{ visit.get_visit_type_display }}</td>
                        <td>{{ visit.queue_number }}</td>
                        <td>
                          <span class="badge bg-{% if visit.status == 'COMPLETED' %}success{% elif visit.status == 'CANCELLED' %}danger{% elif visit.status == 'WAITING' %}warning{% else %}info{% endif %}">
                            {{ visit.get_status_display }}
                          </span>
                        </td>
                        <td>
                          <a href="#" class="btn btn-sm btn-outline-primary">View</a>
                        </td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="6" class="text-center text-muted">No patient visits today</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div><!-- End Today's Visits -->

          <!-- Recent Patient Registrations -->
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title">Recent Patient Registrations</h5>
                  <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="row">
                  {% for patient in recent_patients %}
                  <div class="col-md-4 mb-3">
                    <div class="card border-primary">
                      <div class="card-body">
                        <h6 class="card-title">{{ patient.full_name }}</h6>
                        <p class="card-text small">
                          <i class="bi bi-gender-{{ patient.gender|lower }}"></i> {{ patient.get_gender_display }}<br>
                          <i class="bi bi-calendar"></i> {{ patient.date_of_birth|date:"M d, Y" }} ({{ patient.age }} yrs)<br>
                          <i class="bi bi-telephone"></i> {{ patient.phone_number }}
                        </p>
                        <div class="d-flex justify-content-between">
                          <a href="#" class="btn btn-sm btn-outline-primary">View Record</a>
                          {% if patient.nhif_status == 'ACTIVE' %}
                          <span class="badge bg-success">NHIF</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                  {% empty %}
                  <div class="col-12 text-center text-muted">
                    <p>No recent patient registrations</p>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div><!-- End Recent Patients -->
        </div>
      </div><!-- End Left side columns -->

      <!-- Right side columns -->
      <div class="col-lg-4">
        <!-- System Notifications -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">System Notifications</h5>
            <div class="notifications">
              {% for notification in notifications|slice:":5" %}
              <div class="notification-item p-2 mb-2 rounded {% if not notification.is_read %}bg-light{% endif %}">
                <div class="d-flex justify-content-between">
                  <h6 class="mb-1">{{ notification.title }}</h6>
                  <span class="badge bg-{% if notification.notification_type == 'LAB_RESULT' %}info{% elif notification.notification_type == 'ALLERGY_ALERT' %}danger{% else %}primary{% endif %}">
                    {{ notification.get_notification_type_display }}
                  </span>
                </div>
                <p class="small mb-1">{{ notification.message|truncatechars:80 }}</p>
                <div class="d-flex justify-content-between">
                  <span class="small text-muted">{{ notification.created_at|timesince }} ago</span>
                  <a href="{{ notification.link_url }}" class="small">View</a>
                </div>
              </div>
              {% empty %}
              <p class="text-muted text-center">No new notifications</p>
              {% endfor %}
            </div>
          </div>
        </div><!-- End Notifications -->

        <!-- Doctor Availability -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Doctor Availability</h5>
            <div class="doctor-availability">
              {% for doctor in available_doctors %}
              <div class="doctor-item mb-3 p-2 border rounded">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    {% if doctor.profile.photo %}
                    <img src="{{ doctor.profile.photo.url }}" alt="{{ doctor.get_full_name }}" class="rounded-circle" width="40" height="40">
                    {% else %}
                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                      <i class="bi bi-person text-primary"></i>
                    </div>
                    {% endif %}
                  </div>
                  <div>
                    <strong>Dr. {{ doctor.last_name }}</strong>
                    <div class="small">
                      <span class="badge bg-success">Available</span>
                      <span class="text-muted ms-2">{{ doctor.profile.specialization|default:"General Practitioner" }}</span>
                    </div>
                  </div>
                </div>
              </div>
              {% empty %}
              <p class="text-muted text-center">No doctors available</p>
              {% endfor %}
            </div>
          </div>
        </div><!-- End Doctor Availability -->

        <!-- Prescription Alerts -->
        <div class="card border-warning">
          <div class="card-header bg-warning text-white">
            <h5 class="card-title mb-0"><i class="bi bi-capsule"></i> Prescription Alerts</h5>
          </div>
          <div class="card-body">
            <div class="alert alert-warning">
              <h6>Prescriptions to Fill: <strong>{{ pending_prescriptions.count }}</strong></h6>
            </div>
            <ul class="list-group list-group-flush">
              {% for prescription in pending_prescriptions|slice:":3" %}
              <li class="list-group-item small">
                <i class="bi bi-prescription text-primary"></i>
                {{ prescription.prescription_number }} for {{ prescription.visit.patient.full_name }}
              </li>
              {% empty %}
              <li class="list-group-item text-center text-muted">
                No pending prescriptions
              </li>
              {% endfor %}
              {% if pending_prescriptions.count > 3 %}
              <li class="list-group-item text-center">
                <a href="{% url 'prescription_list' %}" class="small">+ {{ pending_prescriptions.count|add:"-3" }} more</a>
              </li>
              {% endif %}
            </ul>
          </div>
        </div><!-- End Prescription Alerts -->

        <!-- Ward Occupancy -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Ward Occupancy</h5>
            <div class="ward-status">
              {% for ward in ward_occupancy %}
              <div class="ward-item mb-2 p-2 border rounded">
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ ward.name }}</span>
                  <span class="badge bg-{% if ward.occupancy_rate > 90 %}danger{% elif ward.occupancy_rate > 70 %}warning{% else %}success{% endif %}">
                    {{ ward.occupied_beds }}/{{ ward.total_beds }}
                  </span>
                </div>
                <div class="progress mt-1" style="height: 5px;">
                  <div class="progress-bar bg-{% if ward.occupancy_rate > 90 %}danger{% elif ward.occupancy_rate > 70 %}warning{% else %}success{% endif %}" 
                       style="width: {{ ward.occupancy_rate }}%"></div>
                </div>
              </div>
              {% empty %}
              <p class="text-muted text-center">No ward data available</p>
              {% endfor %}
            </div>
          </div>
        </div><!-- End Ward Occupancy -->

        <!-- Hospital Values -->
        <div class="card">
          <div class="card-body text-center" style="background-color: #1a76d1; color: white;">
            <h5 class="card-title">Our Values</h5>
            <div class="values-carousel">
              <div class="value-item">
                <i class="bi bi-heart-pulse display-6"></i>
                <p class="mb-0">Compassion</p>
              </div>
              <div class="value-item">
                <i class="bi bi-shield-check display-6"></i>
                <p class="mb-0">Safety</p>
              </div>
              <div class="value-item">
                <i class="bi bi-people-fill display-6"></i>
                <p class="mb-0">Teamwork</p>
              </div>
            </div>
          </div>
        </div><!-- End Values Card -->
      </div><!-- End Right side columns -->
    </div>
</section>

<style>
  /* Clinic Theme Enhancements */
  .card-icon {
    width: 50px;
    height: 50px;
  }
  
  .doctor-item, .ward-item {
    transition: all 0.3s ease;
  }
  
  .doctor-item:hover, .ward-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(26, 118, 209, 0.1);
  }
  
  .values-carousel {
    display: flex;
    justify-content: space-around;
    text-align: center;
  }
  
  .value-item {
    padding: 10px;
  }
  
  .value-item i {
    color: white;
    margin-bottom: 10px;
  }
  
  .notification-item {
    border-left: 3px solid #1a76d1;
  }
  
  .notification-item.unread {
    background-color: rgba(26, 118, 209, 0.05);
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Close alert messages
  document.querySelectorAll('.btn-close').forEach(button => {
    button.addEventListener('click', function() {
      this.closest('.alert').style.display = 'none';
    });
  });
  
  // Simple carousel for values
  const valueItems = document.querySelectorAll('.value-item');
  let currentItem = 0;
  
  function rotateValues() {
    valueItems.forEach(item => item.style.display = 'none');
    valueItems[currentItem].style.display = 'block';
    currentItem = (currentItem + 1) % valueItems.length;
  }
  
  // Show first value immediately
  valueItems.forEach((item, index) => {
    if(index !== 0) item.style.display = 'none';
  });
  
  // Rotate every 3 seconds
  setInterval(rotateValues, 3000);
  
  // Auto-refresh dashboard every 30 seconds
  setInterval(() => {
    window.location.reload();
  }, 30000);
});
</script>
{% endblock %}